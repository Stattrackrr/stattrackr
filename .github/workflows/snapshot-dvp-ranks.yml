name: Snapshot DvP Ranks

on:
  # Run once daily at 5:30 PM Sydney time (Australia) - same as player props
  schedule:
    - cron: '30 6 * * *'  # 5:30 PM AEDT (6:30 AM UTC) / 4:30 PM AEST
  # Also allow manual trigger
  workflow_dispatch:
    inputs:
      date:
        description: 'Snapshot date (YYYY-MM-DD); blank = today'
        required: false
        default: ''

concurrency:
  group: snapshot-dvp-ranks
  cancel-in-progress: false  # Don't cancel - let it complete

env:
  TZ: America/New_York

jobs:
  snapshot_dvp_ranks:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Allow up to 30 minutes for snapshotting
    continue-on-error: true  # Don't fail workflow if snapshot fails
    env:
      PROD_URL: ${{ secrets.PROD_URL }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check if PROD_URL is configured
        id: check_prod_url
        run: |
          if [ -z "$PROD_URL" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è PROD_URL not configured - skipping snapshot"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PROD_URL configured"
          fi
      
      - name: Snapshot DvP Ranks
        if: steps.check_prod_url.outputs.configured == 'true'
        run: |
          DATE_PARAM=""
          if [ -n "${{ inputs.date }}" ]; then
            DATE_PARAM="?date=${{ inputs.date }}"
          fi
          
          echo "üì∏ Snapshotting DvP ranks${DATE_PARAM:+ for date ${{ inputs.date }}}..."
          
          # Use -L to follow redirects (HTTP 307)
          RESPONSE=$(curl -s -L -X POST "${PROD_URL}/api/dvp/rank/snapshot${DATE_PARAM}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ DvP ranks snapshot successful"
            echo "$BODY" | jq '.' || echo "$BODY"
          else
            echo "‚ùå DvP ranks snapshot failed (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi
      
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check_prod_url.outputs.configured }}" == "false" ]; then
            echo "‚ö†Ô∏è Skipped: PROD_URL not configured"
          elif [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ DvP ranks snapshot completed successfully"
          else
            echo "‚ùå DvP ranks snapshot failed"
          fi




