name: Auto Rosters and Latest Ingest

on:
  schedule:
    # Every 5 minutes from 22:00â€“07:59 UTC (typical North America game window)
    - cron: '*/5 22-23 * * *'
    - cron: '*/5 0-7 * * *'
    # Nightly safety pass at 10:30 UTC
    - cron: '30 10 * * *'
  workflow_dispatch: {}

jobs:
  warm_and_ingest:
    runs-on: ubuntu-latest
    env:
      PROD_URL: ${{ secrets.PROD_URL }}
    steps:
      - name: Guard when PROD_URL is missing
        if: env.PROD_URL == ''
        run: |
          echo "PROD_URL secret not set; skipping." && exit 0

      - name: Warm depth charts T-10
        run: |
          curl -sS "$PROD_URL/api/depth-chart/warm-tminus10?window_min=15" -H 'Accept: application/json' || true

      - name: Ingest latest finals (league-wide)
        run: |
          YEAR=$(date -u +%Y)
          curl -sS "$PROD_URL/api/dvp/ingest-nba-all?season=$YEAR&latest=1" -H 'Accept: application/json' || true
