name: Auto Rosters and Latest Ingest

on:
  schedule:
    # Every 5 minutes from 22:00–07:59 UTC (typical North America game window)
    - cron: '*/5 22-23 * * *'
    - cron: '*/5 0-7 * * *'
    # Nightly safety pass at 10:30 UTC
    - cron: '30 10 * * *'
  workflow_dispatch: {}

jobs:
  warm_and_ingest:
    runs-on: ubuntu-latest
    # Don't fail the workflow if requests fail
    continue-on-error: true
    env:
      PROD_URL: ${{ secrets.PROD_URL }}
    steps:
      - name: Check if PROD_URL is configured
        id: check_prod_url
        run: |
          if [ -z "${{ secrets.PROD_URL }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "⚠️ PROD_URL secret not set; skipping workflow"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Warm depth charts T-10
        if: steps.check_prod_url.outputs.configured == 'true'
        continue-on-error: true
        run: |
          curl -fsS --max-time 30 --retry 2 "$PROD_URL/api/depth-chart/warm-tminus10?window_min=15" -H 'Accept: application/json' || echo "Depth chart warm failed but continuing"

      - name: Ingest latest finals (league-wide)
        if: steps.check_prod_url.outputs.configured == 'true'
        continue-on-error: true
        run: |
          YEAR=$(date -u +%Y)
          curl -fsS --max-time 60 --retry 2 "$PROD_URL/api/dvp/ingest-nba-all?season=$YEAR&latest=1" -H 'Accept: application/json' || echo "Ingest failed but continuing"
