name: Auto Rosters and Latest Ingest

on:
  schedule:
    - cron: '*/5 22-23 * * *'
    - cron: '*/5 0-7 * * *'
    - cron: '30 10 * * *'
  workflow_dispatch: {}

concurrency:
  group: auto-rosters-and-latest
  cancel-in-progress: true

jobs:
  warm_and_ingest:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Don't fail the workflow if requests fail
    continue-on-error: true
    env:
      PROD_URL: ${{ secrets.PROD_URL }}
      CURL_FLAGS: "-fsS --retry 3 --retry-delay 5 --max-time 30"
    steps:
      - name: Check if PROD_URL is configured
        id: check_prod_url
        run: |
          if [ -z "${{ secrets.PROD_URL }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "⚠️ PROD_URL secret not set; skipping workflow"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Warm depth charts T-10 (window=15m)
        if: steps.check_prod_url.outputs.configured == 'true'
        continue-on-error: true
        run: |
          curl $CURL_FLAGS -H 'Accept: application/json' \
            "$PROD_URL/api/depth-chart/warm-tminus10?window_min=15" || echo "Depth chart warm failed but continuing"

      - name: Ingest latest finals (league-wide)
        if: steps.check_prod_url.outputs.configured == 'true'
        continue-on-error: true
        run: |
          YEAR=$(date -u +%Y)
          curl $CURL_FLAGS -H 'Accept: application/json' \
            "$PROD_URL/api/dvp/ingest-nba-all?season=$YEAR&latest=1" || echo "Ingest failed but continuing"
