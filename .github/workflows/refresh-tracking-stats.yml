name: Refresh Tracking Stats

on:
  # Run daily at 3 AM ET (8 AM UTC) - after NBA games are finalized
  schedule:
    - cron: '0 8 * * *' # 8 AM UTC = 3 AM ET
  # Manual trigger (optional)
  workflow_dispatch: {}

concurrency:
  group: refresh-tracking-stats
  cancel-in-progress: false  # Don't cancel - let it complete

jobs:
  refresh_tracking_stats:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Allow up to 15 minutes (refresh takes ~7-8 minutes)
    env:
      PROD_URL: ${{ secrets.PROD_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check if PROD_URL is configured
        id: check_prod_url
        run: |
          if [ -z "${{ secrets.PROD_URL }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è PROD_URL secret not set; skipping workflow"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Refresh Tracking Stats (Season-only via Vercel cron)
        if: steps.check_prod_url.outputs.configured == 'true'
        run: |
          echo "üîÑ Starting season-only tracking stats refresh..."
          echo "üì° Calling: ${{ secrets.PROD_URL }}/api/cron/refresh-tracking-season"
          
          response=$(curl -L -s --max-time 600 -w "\n%{http_code}" "${{ secrets.PROD_URL }}/api/cron/refresh-tracking-season" || echo "ERROR")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Season tracking refresh successful!"
            echo "$body" | jq '.'
            
            elapsed=$(echo "$body" | jq -r '.elapsed // "unknown"')
            api_calls=$(echo "$body" | jq -r '.apiCalls // 0')
            echo ""
            echo "üìä Summary:"
            echo "  - API Calls: $api_calls"
            echo "  - Elapsed: $elapsed"
          else
            echo "‚ùå Season tracking refresh failed with HTTP $http_code"
            echo "$body"
            exit 1
          fi

